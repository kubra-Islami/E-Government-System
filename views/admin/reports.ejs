<div class="container-fluid py-4">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-3 rounded-3 shadow-sm">
            <li class="breadcrumb-item">
                <a href="/admin/dashboard" class="text-decoration-none text-secondary">
                    <i class="bi bi-speedometer2 me-1"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item active text-primary fw-semibold" aria-current="page">
                Reports
            </li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <h2 class="fw-bold text-primary mb-3 mb-md-0">
            <i class="bi bi-graph-up-arrow me-2"></i> Reports & Insights
        </h2>
        <button id="exportBtn" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-download me-1"></i> Export As CSV
        </button>
    </div>

    <% if (reports && reports.length > 0) { %>
        <%
            const totals = {
                total: reports.reduce((s, r) => s + Number(r.total || 0), 0),
                submitted: reports.reduce((s, r) => s + Number(r.submitted || 0), 0),
                under_review: reports.reduce((s, r) => s + Number(r.under_review || 0), 0),
                approved: reports.reduce((s, r) => s + Number(r.approved || 0), 0),
                rejected: reports.reduce((s, r) => s + Number(r.rejected || 0), 0),
                fees: reports.reduce((s, r) => s + Number(r.fees || 0), 0).toFixed(2)
            };
        %>


        <!-- Summary Cards -->
        <div class="row g-4 mb-5">
            <% const summaryData = [
                {icon: 'bi-files', label: 'Total Requests', value: totals.total, color: 'text-primary'},
                {icon: 'bi-check-circle', label: 'Approved', value: totals.approved, color: 'text-success'},
                {icon: 'bi-x-circle', label: 'Rejected', value: totals.rejected, color: 'text-danger'},
                {icon: 'bi-currency-dollar', label: 'Collected Fees', value: `$${totals.fees}`, color: 'text-warning'}
            ]; %>
            <% summaryData.forEach(item => { %>
                <div class="col-md-3 col-sm-6">
                    <div class="card shadow-sm border-0 rounded-4 text-center h-100">
                        <div class="card-body">
                            <i class="bi <%= item.icon %> fs-2 <%= item.color %> mb-2"></i>
                            <h6 class="text-muted"><%= item.label %></h6>
                            <h3 class="fw-bold"><%= item.value %></h3>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>

        <!-- Doughnut Chart -->
        <div class="card shadow-sm border-0 rounded-4 mb-5">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-semibold"><i class="bi bi-pie-chart me-2"></i> Overall Statistics</h5>
            </div>
            <div class="card-body d-flex justify-content-center">
                <div style="max-width: 300px; width: 100%;">
                    <canvas id="summaryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Department Reports -->
        <div class="row g-4">
            <% reports.forEach(r => { %>
                <div class="col-lg-6 col-md-12">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-building me-2"></i> <%= r.department %></h5>
                            <span class="badge bg-light text-dark px-3 py-2">Total: <%= r.total %></span>
                        </div>
                        <div class="card-body">
                            <!-- Department Stats -->
                            <div class="row text-center mb-3">
                                <div class="col-4">
                                    <span class="fw-bold text-success fs-5"><%= r.approved %></span>
                                    <p class="text-muted small mb-0">Approved</p>
                                </div>
                                <div class="col-4">
                                    <span class="fw-bold text-danger fs-5"><%= r.rejected %></span>
                                    <p class="text-muted small mb-0">Rejected</p>
                                </div>
                                <div class="col-4">
                                    <span class="fw-bold text-warning fs-5">$<%= r.fees %></span>
                                    <p class="text-muted small mb-0">Fees Collected</p>
                                </div>
                            </div>

                            <!-- Services Table -->
                            <% if (r.services && r.services.length > 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                        <tr>
                                            <th>Service</th>
                                            <th class="text-center">Requests</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <% r.services.forEach(s => { %>
                                            <tr>
                                                <td><i class="bi bi-gear me-2 text-secondary"></i> <%= s.name %></td>
                                                <td class="text-center">
                                                    <span class="badge bg-info text-dark px-3 py-2"><%= s.total %></span>
                                                </td>
                                            </tr>
                                        <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                            <% } else { %>
                                <p class="text-muted fst-italic">No service data available for this department.</p>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>

    <% } else { %>
        <!-- Empty State -->
        <div class="text-center py-5">
            <i class="bi bi-emoji-frown text-muted fs-1 mb-3"></i>
            <p class="text-muted fs-5">No report data available yet</p>
        </div>
    <% } %>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const chartTotals = <%- JSON.stringify({
            submitted: reports.reduce((s, r) => s + Number(r.submitted || 0), 0),
            under_review: reports.reduce((s, r) => s + Number(r.under_review || 0), 0),
            approved: reports.reduce((s,r) => s + Number(r.approved || 0),0),
            rejected: reports.reduce((s,r) => s + Number(r.rejected || 0),0)
        }) %>;

        const ctx = document.getElementById('summaryChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Submitted', 'Under Review', 'Approved', 'Rejected'],
                    datasets: [{
                        data: [
                            chartTotals.submitted,
                            chartTotals.under_review,
                            chartTotals.approved,
                            chartTotals.rejected
                        ],
                        backgroundColor: ['#0dcaf0','#ffc107','#198754','#dc3545'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, boxWidth: 20 }
                        }
                    }
                }
            });
        }
    });
</script>

<script>
    document.getElementById('exportBtn').addEventListener('click', () => {
        let csv = 'Department,Submitted,Under Review,Approved,Rejected,Fees\n';
        const reports = <%- JSON.stringify(reports) %>;
        reports.forEach(r => {
            csv += `${r.department},${Number(r.submitted||0)},${Number(r.under_review||0)},${Number(r.approved||0)},${Number(r.rejected||0)},${Number(r.fees||0)}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'reports.csv';
        a.click();
        URL.revokeObjectURL(url);
    });
</script>



<style>
    /* Card hover effect */
    .card:hover {
        transform: translateY(-2px);
        transition: 0.3s;
    }
</style>
