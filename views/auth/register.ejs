<div class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="col-md-7 col-lg-6">
        <div class="card shadow rounded-3">
            <div class="card-body p-4">
                <h3 class="text-center mb-4 fw-bold text-primary">
                    <i class="bi bi-person-plus me-2"></i> Register
                </h3>

                <% if (typeof error !== 'undefined') { %>
                    <div class="alert alert-danger"><%= error %></div>
                <% } %>

                <form action="/api/users/register" method="POST" id="registerForm" novalidate>
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input
                                type="text"
                                class="form-control"
                                id="name"
                                name="name"
                                placeholder="Enter your full name"
                                required>
                        <div class="invalid-feedback">Please enter your full name.</div>
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address <span class="text-danger">*</span></label>
                        <input
                                type="email"
                                class="form-control"
                                id="email"
                                name="email"
                                placeholder="Enter your email"
                                required>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>

                    <!-- Password -->
                    <div class="mb-3 position-relative">
                        <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                        <input
                                type="password"
                                class="form-control"
                                id="password"
                                name="password"
                                placeholder="Enter a strong password"
                                required
                                minlength="6"

                        >
                        <i class="bi bi-eye position-absolute end-0 translate-middle-y me-3"
                           id="togglePassword"
                           style="cursor: pointer; font-size: 1.2rem; color: #6c757d;top: 75%"></i>
                        <div class="invalid-feedback">Please enter your password.</div>
                    </div>

                    <!-- National ID (citizen only) -->
                    <div class="mb-3 citizen-only">
                        <label for="national_id" class="form-label">National ID <span
                                    class="text-danger">*</span></label>
                        <input
                                type="text"
                                class="form-control"
                                id="national_id"
                                name="national_id"
                                placeholder="Enter your national ID"
                                pattern="^\d{10}$"
                                maxlength="10"
                                minlength="10"
                                required>
                        <div class="invalid-feedback">National ID must be exactly 10 digits.</div>
                    </div>


                    <!-- Date of Birth (citizen only) -->
                    <div class="mb-3 citizen-only">
                        <label for="date_of_birth" class="form-label">Date of Birth <span
                                    class="text-danger">*</span></label>
                        <input
                                type="date"
                                class="form-control"
                                id="date_of_birth"
                                name="date_of_birth">
                        <div class="invalid-feedback">Please enter your Date of Birth.</div>
                    </div>

                    <!-- Contact Info -->
                    <div class="mb-3">
                        <label for="contact_info" class="form-label">Contact Info</label>
                        <input
                                type="text"
                                class="form-control"
                                id="contact_info"
                                name="contact_info"
                                placeholder="Phone number or address"
                        >
                    </div>

                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number </label>
                        <input
                                type="tel"
                                class="form-control"
                                id="phone"
                                name="phone"
                                placeholder="Enter your phone number"
                                pattern="^\d{11}$"
                                maxlength="11"
                                minlength="11"
                                required>
                        <div class="invalid-feedback">Phone number must be exactly 11 digits.</div>
                    </div>

                    <!-- Role -->
                    <div class="mb-3">
                        <label for="role" class="form-label">Role <span class="text-danger">*</span></label>
                        <select class="form-select" id="role" name="role" required>
                            <option value="citizen" selected>Citizen</option>
                            <option value="officer">Officer</option>
                            <option value="department_head">Department Head</option>
                            <option value="admin">Admin</option>
                        </select>
                        <div class="invalid-feedback">Please enter your role.</div>
                    </div>

                    <!-- Department (only for officer/admin) -->
                    <div class="mb-3 d-none" id="departmentField">
                        <label for="department_id" class="form-label">Department <span
                                    class="text-danger">*</span></label>
                        <select class="form-select" id="department_id" name="department_id">
                            <option value="0">choose department</option>
                            <% departments.forEach(function(dept) { %>
                                <option value="<%= dept.id %>"><%= dept.name %></option>
                            <% }); %>
                        </select>
                        <div class="invalid-feedback">Please enter the Department you work with.</div>
                    </div>

                    <!-- Job Title (only for officer) -->
                    <div class="mb-3 d-none" id="jobTitleField">
                        <label for="job_title" class="form-label">Job Title <span class="text-danger">*</span></label>
                        <input
                                type="text"
                                class="form-control"
                                id="job_title"
                                name="job_title"
                                placeholder="Enter your job title">
                        <div class="invalid-feedback">Please enter your job title.</div>
                    </div>

                    <!-- Submit -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Register</button>
                    </div>
                </form>

                <p class="text-center mt-3">
                    Already have an account? <a href="/api/users/login" class="fw-bold">Login</a>
                </p>
            </div>
        </div>
    </div>
</div>


<!-- JavaScript to toggle fields based on role -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("registerForm");
        const roleSelect = document.getElementById("role");
        const departmentField = document.getElementById("departmentField");
        const departmentInput = document.getElementById("department_id");
        const jobTitleField = document.getElementById("jobTitleField");
        const jobTitleInput = document.getElementById("job_title");
        const citizenFields = document.querySelectorAll(".citizen-only input, .citizen-only select");
        const togglePassword = document.getElementById("togglePassword");
        const passwordInput = document.getElementById("password");

        function toggleFields() {
            const role = roleSelect.value;

            // Reset requirements
            departmentInput.required = false;
            jobTitleInput.required = false;
            citizenFields.forEach(f => f.required = false);

            if (role === "citizen") {
                departmentField.classList.add("d-none");
                jobTitleField.classList.add("d-none");
                citizenFields.forEach(f => {
                    f.closest(".mb-3").classList.remove("d-none");
                    f.required = true;
                });
            } else if (role === "officer") {
                departmentField.classList.remove("d-none");
                jobTitleField.classList.remove("d-none");
                departmentInput.required = true;
                jobTitleInput.required = true;
                citizenFields.forEach(f => f.closest(".mb-3").classList.add("d-none"));
            } else if (role === "department_head") {
                departmentField.classList.remove("d-none");
                departmentInput.required = true;
                jobTitleField.classList.add("d-none");
                citizenFields.forEach(f => f.closest(".mb-3").classList.add("d-none"));
            } else if (role === "admin") {
                departmentField.classList.add("d-none");
                jobTitleField.classList.add("d-none");
                citizenFields.forEach(f => f.closest(".mb-3").classList.add("d-none"));
            }
        }

        roleSelect.addEventListener("change", toggleFields);
        toggleFields();

        // Bootstrap form validation
        form.addEventListener("submit", function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }

            if (!departmentField.classList.contains("d-none") && departmentInput.value === "0") {
                event.preventDefault();
                event.stopPropagation();
                departmentInput.classList.add("is-invalid");
            } else {
                departmentInput.classList.remove("is-invalid");
            }


            form.classList.add("was-validated");
        }, false);

        // Toggle password visibility
        togglePassword.addEventListener("click", function () {
            const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
            passwordInput.setAttribute("type", type);

            // Switch icon
            this.classList.toggle("bi-eye");
            this.classList.toggle("bi-eye-slash");
        });
    });
</script>

